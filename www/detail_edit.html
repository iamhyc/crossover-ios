<!DOCTYPE html>

<html style="height:100%">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<title>Detail_edit</title>
	<script src="javascripts/jquery-1.11.2.js"></script>
	<script type="text/javascript" src="javascripts/styleFunc.js"></script>
	<link rel='stylesheet' href='stylesheets/bootstrap.css' />
	<link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
	<script type="text/javascript">
		var apiAddress = "http://120.24.223.82:8080/Crossover/Api/";
  		var imgAddress = "http://120.24.223.82:8080/Crossover/images/";
  		var myObj = JSON.parse(localStorage.current_user);

		$(document).ready(function(){
			document.getElementById("teamLogo").addEventListener('change',uploadCheck,false );
			//INITIALIZATION ON
			$('#team_name').val(myObj.TeamName);
			$('#team_intro').val(myObj.Intro);
			$('#team_city').val(myObj.City);
			$('#myHead').attr("src", imgAddress+"TeamLogo/"+myObj.TeamLogo);
			//INITIALIZATION DOWN

			$("#changeLogo").click(function(){
				$("#teamLogo").click();
			})
		})

		function uploadCheck () {
			var file = this.files[0]; 
				var reader = new FileReader(); 
				reader.readAsDataURL(file);
				/* */ 
				reader.onloadend = function(e) {
					var data = JSON.stringify({
							'TeamID': myObj.TeamID,
							'PhotoBase64': this.result.slice(this.result.indexOf(',')+1)
					});
					console.log(1);
					$.ajax({
						type:'post',
						url: apiAddress+"team/photo/logo",
						contentType: 'application/json',
						dataType:'json',
						data:data,
						success: 
							function(result){
								if(!result) {
									alert_flash("上传失败");
									console.log("fail");
								}
								else {
									$('#myHead').attr('src', this.result);
									alert_flash("头像上传成功");
									console.log(result)
								}
							}
					})
				}		
		}

		function saveCheck(){
			var name = $('#team_name').val(),
				intro = $('#team_intro').val(),
				city = $('#team_city').val();
			if (name.length>15||name.length<2) alert_flash("队名为2-15位")
			else if (intro.length == 0) alert_flash("请填写战队简介")
			else {
				var data = JSON.stringify({
						'TeamID': myObj.TeamID,
						'TeamName': name,
						'Intro': intro,
						'City': city
				});
				$.ajax({
						type:'post',
						url: apiAddress+'team/update',
						contentType: 'application/json',
						dataType:'json',
						data:data,
						success: 
							function(result){
								if (result.success){
									alert_flash("保存成功");
									window.location.href = "personal.html";
								}
								else{
									alert_flash("失败");
								}
							}
				})
			}
		}
	</script>
</head>

<body background="images/bg.jpg" style="height:100%">
	<div class="container" style="height:100%;color:#ffffff">
		<nav class="navbar navbar-fixed-top text-left">
    		<span onclick="history.back()"><img src="images/back.png" width="14%"></span>		
	    </nav>
		
		<div class="container-fluid" style="height:20%">
			<div class="spc" style="height:40%"></div>
			<div class="row">
  				<div class="col-xs-5 col-sm-5">
  					&nbsp;&nbsp;&nbsp;&nbsp;
  					<img id="myHead" src="abc.jpg" class="img-circle" width="72px" height="72px">
  					<input type="file" accept="image/*" class="hidden" name="imgFile" id="teamLogo" />
  				</div>
  				<br />
  				<div class="col-xs-6 col-sm-6">
  					<button type="button" id="changeLogo" class="btn btn-lg btn-block">更换队标</button>
  				</div>
			</div>

		</div>
		<div class="container text-left" style="height:60%">
			<h3>完善战队资料</h3><br />
			<form class="form-horizontal" style="width:100%">
				<div class="col-xs-offset-1">
  					<div class="form-group">
    					<input type="text" class="net-control input-lg" id="team_name" placeholder="队名" style="width:90%">
  					</div>
  				</div>
  				
  				<div class="col-xs-offset-1">
  					<div class="form-group">
      					<textarea class="net-control input-lg" id="team_intro" rows="5" placeholder="战队简介" style="width:90%"></textarea>
    				</div>
    			</div>

    			<div class="col-xs-offset-1">
  					<div class="form-group">
      					<input type="text" class="net-control input-lg" id="team_city" placeholder="城市" style="width:90%">
    				</div>
    			</div>
			</form>
		</div>

		<div class="text-center" style="height:20%">
			<div class="spc" style="height:35%"></div>
			<div class="inline-btn" style="display:inline-block;width:35%;">
				<button class="btn btn-lg btn-block" onclick="saveCheck()">保存</button>
			</div>	
		</div>
</body>
</html>