<!DOCTYPE html>

<html style="height:100%">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<title>Personal</title>
	<script src="javascripts/jquery-1.11.2.js"></script>
  <script type="text/javascript" src="javascripts/jquery.base64.js"></script>
  <script type="text/javascript" src="javascripts/styleFunc.js"></script>
  <script type="text/javascript" src="javascripts/DES.js"></script>
	<link rel='stylesheet' href='stylesheets/bootstrap.css' />
	<link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
	<script type="text/javascript">
  localStorage.lastView = "personal.html";
  var apiAddress = "http://120.24.223.82:8080/Crossover/Api/";
  var imgAddress = "http://120.24.223.82:8080/Crossover/images/";
  var myObj = JSON.parse(localStorage.current_user);
  var myData, myList, myPlayer, myTodo;
  var stateMap = new Array();

  $(document).ready(function(){
    //INITIALIZE ON
      $('#myHead').attr("src", imgAddress + "TeamLogo/" +myObj.TeamLogo);
      $('#myName').text(myObj.TeamName);
      $('#grade > font').text(myObj.lntegral);
      $('.back').click(function(){
        $('#imgHome').click();
      });
      document.getElementById("imgHome").addEventListener( 'change',preview,false );

      if (myObj.TeamHomePhoto == ""){
        $('#back').attr("src", "images/white.png").css("position", "absolute").css("left", "40%").css("top", "15%");
      }
      else {
        $('#back').attr("src", imgAddress+"TeamHome/"+myObj.TeamHomePhoto).attr("width", "100%").attr("height", "100%");

      }

      $.get(apiAddress + "team/teammate/user/"+myObj.UserID+"/team/"+myObj.TeamID, function(data){
        if (myObj.AdminID!=data.AdminID) {
          localStorage.current_user = null;
          window.location.href = "index.html";
        }
        myData = data;  //console.log(data);
        myList = data.scoreList;  //console.log(myList);
        myTodo = data.readyList;  //console.log(myTodo)
        myPlayer = data.players;  //console.log(myPlayer);

        //ADD PLAYER
        for (var i = 0; i < myPlayer.length; i++){
          var img='<div class="col-xs-3 col-sm-3 col-md-3" style="padding-top:5%"><img src="'+imgAddress+'Teammate/'+myPlayer[i].HeadIcon+'" id='+i+' class="img-circle isMem" width="100%" height="100%"></div>';
          $(".portrait").append(img);
        }
        var img='<div class="col-xs-3 col-sm-3 col-md-3" style="padding-top:5%"><img src="images/white-plus.png" id="addMem" class="img-circle" width="100%" height="100%"></div>';
        $(".portrait").append(img);

        longFocus($(".isMem"), function (id){
            //console.log(id)
            confirm_modal("删除该队员?", function (){
              $.get(apiAddress+"player/delete/"+myPlayer[id].PlayerID, function(result){
                if (result) alert_flash("删除成功");
                window.location.reload(true);
              })
            })
        });
        $(".isMem").on('click', function(){
          showMsg(this.id);
        });
        $("#addMem").on('click', function(){
          location.href = "member_add.html";
        });
        //END FOR ADD PLAYER

        //BEGINNING FOR READY LIST PART
        generateReadyList();
        //END FOR READYLIST PART
        
        //BEGGING FOR FINISHED LIST
        if (myList.length > 0) generateFinishedList();
        //END FOR FINISHED LIST
      })

    //INITIALIZE OFF

      $(".score").click(function(){
          if ($('.against').hasClass('hidden')){
            $("#block-bg").css("display", "block");
            $(".against").removeClass('hidden').animate({bottom:"10%"});
          } 
          else {
            $("#block-bg").css("display", "none");
            $(".against").animate({bottom:"-80%"}, function(){$(".against").addClass('hidden')});
            generateReadyList();
          }
      });

      $("#block-bg").click(function(){
          $("#block-bg").css("display", "none");
          $(".against").animate({bottom:"-80%"}, function(){$(".against").addClass('hidden')});
          generateReadyList();
      });

  });

  function generateReadyList () {
    $(".record > .processItem").remove();
    $(".THead1").attr("src", imgAddress+"TeamLogo/"+myObj.TeamLogo);
    $(".TName1 font").text(myObj.TeamName);

        for (var i = myTodo.length-1; i >= 0; i--){
          //var block="<div id="+myTodo.ArrangeID+"></div>"
          $(".fakeBox1 .THead2").attr("src", imgAddress+"TeamLogo/"+myTodo[i].TeamLogo);
          $(".fakeBox1 .TName2 font").text(myTodo[i].TeamName);
          stateMap[i] = 0;  
          $(".fakeBox1 .processItem").attr("id", i);
          $(".fakeBox1 .processBtn").attr("name", i);

          $(".fakeBox1 .3_t1 > p > font").attr("ArrID", i);
          $(".fakeBox1 .2_t1 > p > font").attr("ArrID", i);
          $(".fakeBox1 .1_t1 > p > font").attr("ArrID", i);
          $(".fakeBox1 .3_t2 > p > font").attr("ArrID", i);
          $(".fakeBox1 .2_t2 > p > font").attr("ArrID", i);
          $(".fakeBox1 .1_t2 > p > font").attr("ArrID", i);

          $(".record").prepend($(".fakeBox1 > .processItem").clone());
        }
  }

  function generateFinishedList () {
    $(".record").append('<div class="space" style="height:2em"></div>');
    
    for (var i = 0; i < myList.length; i++){
      $(".fakeBox2 .THead2").attr("src", imgAddress+"TeamLogo/"+myList[i].TeamLogo);
      $(".fakeBox2 .TName2 font").text(myList[i].TeamName); 

      var score = myList[i].Score.split(',');
      //console.log(score);
      if (myList[i].ActiveID == myList[i].ActiveTeamID){
        setScore(zeroFill(score[0]), zeroFill(score[1]))
      }
      else {
        setScore(zeroFill(score[1]), zeroFill(score[0]));
      }

      $(".record").append($(".fakeBox2 > .scoreItem").clone());
    }
  }
  function setScore(t1, t2) {
    if (parseInt(t1)>parseInt(t2)){
      $(".fakeBox2 .Team1 .vs").css("background", "#007979");
      $(".fakeBox2 .Team2 .vs").css("background", "#E0E0E0");
    }
    else{
      $(".fakeBox2 .Team1 .vs").css("background", "#E0E0E0");
      $(".fakeBox2 .Team2 .vs").css("background", "#007979");
    }
    $(".fakeBox2 .Team1 .3_t1 p font").text(t1[0]);  
    $(".fakeBox2 .Team1 .2_t1 p font").text(t1[1]);  
    $(".fakeBox2 .Team1 .1_t1 p font").text(t1[2]);
    $(".fakeBox2 .Team2 .3_t2 p font").text(t2[0]);  
    $(".fakeBox2 .Team2 .2_t2 p font").text(t2[1]);  
    $(".fakeBox2 .Team2 .1_t2 p font").text(t2[2]);
  }
  function zeroFill (str) {
    while(str.length < 3){
      str = "0" + str;
    }
    return str;
  }

  function process(obj) {
    var order = obj.attr("name");
    var selected = "#"+order+".processItem ";
    stateMap[order]++;  //console.log(stateMap[order]);
    switch(stateMap[order]){
      case 1:
        $(selected+".processBtn > font").text("确定");
        $(selected+" .Info2").removeClass("hidden");
        break;
      case 2:
        $(selected+".Info2").addClass("hidden");
        $(selected+".Info1").removeClass("hidden");
        break;
      case 3:
        if (judgeEqual(selected)){
          $(selected+".Info1").addClass("hidden");
          $(selected+".processBtn > font").text("提交分数");
          break;
        }
        else{
          alert_flash("分数不能相同，请重新填写");
          stateMap[order]--;
          break;
        }
      case 4:
          var msg = myTodo[order].TeamName+"战队输入管理员密码";
          prompt_modal(msg, function(pwd){
              if (!pwd) {
                alert_flash("请输入密码");
                stateMap[order]--;
              }
              else{
                pwd = $.base64.btoa(des("isalways", pwd, 1, 0, "", 1));
                var data = JSON.stringify({
                    "VerifyID":myTodo[order].TeamID,
                    "Password":pwd,
                    "ActiveID":myTodo[order].ActiveID,
                    "ReceiveID":myTodo[order].ReceiveID,
                    "Score":judgeEqual(selected),
                    "ArrangeID":myTodo[order].ArrangeID
                });
                //console.log(data);
                $.ajax({
                  type:'post',
                  url: apiAddress+"record",
                  contentType: 'application/json',
                  dataType:'json',
                  data:data,
                  success: 
                      function(result){
                        if (result.success) {
                          alert_flash("上传比分成功");
                           window.location.reload(true);
                        }
                        else if (!result.success) {
                          alert_flash("输入的密码错误");
                          stateMap[order]--;
                        }
                      }
                })
              }
          });
        break;
      default:
         stateMap[order]--;
         break;
    }
  }

  function judgeEqual (item) {
    var score1 = getTeam(item, 1);
    var score2 = getTeam(item, 2);
    if (score1==score2) return false;
    else return(score1+","+score2);
  }

  function getTeam (item, order) {
    var sub = " p font";
    return $(item+" .3_t"+order+sub).text()+$(item+" .2_t"+order+sub).text()+$(item+" .1_t"+order+sub).text();
  }

  function dynamic(obj){
    var state = stateMap[obj.attr("ArrID")],
        teamid = obj.attr("TeamID");
    var number = parseInt(obj.text());
    if ((state=="1"&&teamid=="2")||(state=="2"&&teamid=="1"))
    obj.text((number+1)%10);
   }

  function addMem(){
    window.location.href = "member_add.html";
  }

  function deal_spc (content) {
    content=content.replace(/\r\n/g,"<BR>")  
    content=content.replace(/\n/g,"<BR>");  
    return content;
  }
  function showMsg(usr){
    //console.log(usr);
    $('#black-bg').css("display", 'block');
      $('#name').text(myPlayer[usr].PlayerName);
      $('#height').text("身高："+myPlayer[usr].tall);
      $('#weight').text("体重："+myPlayer[usr].weight);
      $('#site').text("所打位置："+myPlayer[usr].position);
      $('#intro').html("简介："+deal_spc(myPlayer[usr].Detail));
      //console.log(myPlayer[usr].Detail);
      $('#memHead').attr("src", imgAddress+"Teammate/"+myPlayer[usr].HeadIcon);
    $('.show-block').removeClass("hidden").fadeIn(400);
    //$('body').append(block);
  }
  function deMsg(){
    $('.show-block').fadeOut(400,function(){
      $(this).addClass("hidden");
      $('#black-bg').css('display', 'none');
    });
  }

  function preview(){
      //var patn = /\.jpg$|\.jpeg$|\.png$|\.gif$/i;
        var file = this.files[0]; 
        var reader = new FileReader(); 
        reader.readAsDataURL(file);
        /* */ 
        reader.onloadend = function(e) {
          var data = JSON.stringify({
                  "TeamID":myObj.TeamID,
                  "PhotoBase64": this.result.slice(this.result.indexOf(',')+1)
          });
          $.ajax({
            type:'post',
            url: apiAddress+"team/photo/home",
            contentType: 'application/json',
            dataType:'json',
            data:data,
            success: 
              function(result){
                if (!result){
                  alert_flash("上传失败")
                }
                else{
                  $('#back').attr('src', this.result);
                }
              }
          })
          $('#back').attr('src', this.result);
        }
  }

  function turnToPhotos () {
    localStorage.galleryShow = "1_"+myObj.TeamID;
    window.location.href = 'photos.html';
  }

	</script>
</head>

<body background="images/bg.jpg" style="height:100%">
  <div id="block-bg"></div><div id="black-bg"></div>

  <nav class="navbar navbar-fixed-top">
      <span class="text-left" onclick="location.href='menu.html'"><img src="images/back.png" width="14%"></span>
      <span style="margin:0 0 0 70%" onclick="location.href='detail_edit.html'"><img src="images/edit.png" width="14%"></span>
  </nav>

  <div class="back" style="height:40%;width:100%;text-align:center">
    <img src="" id="back">
	</div>
  <input type="file" accept="image/*" class="hidden" name="imgHome" id="imgHome"  />

	<div class="container-fluid" style="height:10%;background:#ffffff">
		<div class="row">
  			<div class="col-xs-4 col-sm-4 col-md-4">
  				<h4 id="position" style="text-align:left">广东深圳</h4>
  			</div>
  			<div class="col-xs-4 col-sm-4 col-md-4" style="margin-top:-10%;text-align:center">
  				<img id="myHead" src="abc.jpg" class="img-circle" width="80%" height="80%">
  				<p id="myName" style="text-align:center">干</p>
  			</div>
  			<div class="col-xs-4 col-sm-4 col-md-4" style="padding:3% 3% 0 0;text-align:right">
  				<button class="btn btn-lg" style="padding:0; width:80%; height:2em;text-align:center; background:#E0E0E0" onclick="turnToPhotos()">相册</button>
  			</div>
		</div>
		
	</div>
  <div class="spa" style="height:0.3%"></div>
	<div class="container-fluid" style="height:38%;background:#ffffff">
		<h4 style="text-align:center">队员</h4>
		<div class="row portrait" style="overflow:scroll">

		</div>
	</div>
		
	<div class="score" style="height:11%">
		<div class="row" style="color:#ffffff;padding-top:3%;height:100%;width:102%">
  			<div class="col-xs-4 text-left" style="padding:2% 0 0 10%">
  				<span class="glyphicon glyphicon-star" style="font-size:2em"></span>
  			</div>
  			<div class="col-xs-4 text-center" id="grade" style="padding:0 auto">
  			   <font color="#FFFFFF" size="6">1000</font>
  			</div>
  			<div class="col-xs-4 text-right" style="padding:2% 8% 0% 0%">
  				  <span class="glyphicon glyphicon-star" style="font-size:2em"></span>
  			</div>
		</div>
	</div>




  <div class="hidden show-block" style="z-index:1092;top:40%;left:3%;width:94%;background:#003D79;border-radius:1em;color:#FFFFFF;position:absolute;">
    <div class="row" style="margin:0 0 0 0" >
      <div class="col-xs-4" style="padding:3% 0%  0% 3%">
        <img id="memHead" src="abc.jpg" class="img-circle" width="70%" height="70%">
      </div>
      <div class="col-xs-8" style="padding-top:4%;height:100%;margin-left:-10%;font-size:1.2em">
        <div id="name" style="height:15%">aaa</div>
        <div id="height"style="height:10%">身高:aaa</div>
        <div id="weight" style="height:10%">体重:aaa</div>
        <div id="site" style="height:10%">所打位置:aaa</div>
        <div id="intro" style="height:10%">简介:aaa </div>
        <div class="spc" style="height:10%;"></div>
        <div style="height:30%;color:#003D79;padding:8% 0 4% 0">
          <button class="btn btn-large" type="button" onclick="deMsg()" style="width:50%;border-radius:0.7em"><font size="3em" color="#003D79">确定</font></button>
        </div>
      </div>
    </div>
  </div>





<div class="against hidden" style="height:80%;width:100%;position:absolute;z-index:1091">
  <div class="record " style="background:#FFFFFF;height:100%;width:100%;padding:2% 0 0 2%;overflow:scroll">
      <div class="fakeBox1 hidden">
      <!--BEGINNING FOR PROCESSING LIST-->
      <div class="processItem" style="background:#F6F7F7;width:94.5%;margin:0 auto;padding:2% 2% 2% 0">
          <div class="vs" style="background:#E0E0E0;height:19em;width:100%">
            <!--PART 1-->
            <div class="Row1 row" style="height:30%">
          
              <div class="col-xs-3"> 
                <img src="abc.jpg" class="THead1 img-circle" width="80%" height="80%" style="margin-top:13%;margin-left:13%">
              </div>
            
              <div class="col-xs-6">
                <p class="TName1" style="text-align:left;margin-top:18%;margin-left:-18%"><font size="3em" color=" #000093">干</font></p>
                <p style="text-align:center;margin-top:-25%;"><font size="6em" color=" #000093">VS</font></p>
                <p class="TName2" style="text-align:right;margin-right:-15%; margin-top:-27%"><font size="3em" color="#000093">萌萌队</font></p>    
              </div>
          
              <div class="col-xs-3">
                <img src="abc.jpg" class="THead2 img-circle" width="80%" height="80%" style="margin-top:13%;margin-right:13%">
              </div>  

            </div>
            <!--END FOR PART 1-->
            <!--PART 2-->
            <div class="againstScore" style="display:inline-flex;height:5em;width:100%">

              <div class="t1" style="width:52%;height:100%; display:inline-flex">
                <div class="space" style="height:5em;width:10%;display:inline"></div>

                <div class="3_t1" style="height:5em;width:2.4em;background:#FFFFFF" >
                    <p style="text-align:center" ><font size="8em" color="#000093" onclick="dynamic($(this))" teamid="1">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline"></div>


                <div class="2_t1" style="height:5em;width:2.4em;display:inline;background:#FFFFFF">
                    <p style="text-align:center" ><font size="8em" color="#000093" onclick="dynamic($(this))" teamid="1">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline"></div>


                <div class="1_t1" style="height:5em;width:2.4em;display:inline;background:#FFFFFF">
                    <p style="text-align:center" ><font size="8em" color="#000093" onclick="dynamic($(this))" teamid="1">0</font></p>
                </div>
                <div class="devider" style="height:5em;width:3em;display:inline;" >
                    <p style="text-align:right;margin-top:1em"><font size="8em" color="#000093">:</font></p>
                </div>
              </div>

              <div class="t2" style="width:48%;height:100%;display:inline-flex">
                <div class="space" style="height:5em;width:14%;display:inline;"></div>

                <div class="3_t2" style="height:5em;width:2.4em;display:inline;background:#FFFFFF">
                    <p style="text-align:center" ><font size="8em" color="#000093" onclick="dynamic($(this))" teamid="2">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline;" ></div>


                <div class="2_t2" style="height:5em;width:2.4em;display:inline;background:#FFFFFF">
                    <p style="text-align:center" ><font size="8em" color="#000093" onclick="dynamic($(this))" teamid="2">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline;"></div>


                <div class="1_t2" style="height:5em;width:2.4em;display:inline;background:#FFFFFF">
                  <p style="text-align:center" ><font size="8em" color="#000093" onclick="dynamic($(this))" teamid="2">0</font></p>
                </div>

              </div>
            </div>

            <div class="infoBox row text-center" style="color:#000093;height:1em">
              <div class="col-xs-6">
                <p class="Info1 hidden">等待对方填写分数</p>
              </div>
              <div class="col-xs-6">
                <p class="Info2 hidden">等待对方填写分数</p>
              </div>
            </div>
            <!--END FOR PART 1-->
            <div class="space1" style="height:2em"></div>
            <div style="height:5em">
                <p style="text-align:center"><button class="btn btn-large processBtn" type="button" style="width:9em;background:#FFFFFF" onclick="process($(this))"><font color="#000093" size="3em">比赛结束</font></button></p>
            </div>
          </div>
      </div>
      <!--END FOR PROCESS LIST-->
      </div>


      <!--<div class="space" style="height:2em"></div>-->
      

      <div class="fakeBox2 hidden">
      <!--BEGINNING FOR FINISHED LIST-->
      <div class="scoreItem" height="11em" width="100%" >
          <div style="background:#F6F7F7;height:100%;width:100%;display:inline-flex;">
          <div class="Team1" style="width:46%;height:100%;margin-top:3%;margin-bottom:2%;margin-left:2%">
            <div class="vs" style="background:#007979;height:11em">

              <div style="height:4em;width:100%;display:inline-flex">
                <div style="height:4em;width:35%">
                    <img src="abc.jpg" class="THead1 img-circle" width="75%" height="75%" style="margin-top:13%;margin-left:13%">
                </div>
                <div class="TName1" style="height:100%;width:50%">
                    <p style="margin-top:1.2em"><font size="2.5em" color=" #000093">干</font></p>
                </div>
              </div>

              <!--<div class="space" style="height:0.15em;background:#FFFFFF">&nbsp;</div>-->

              <div class="aga" style="display:inline-flex;height:2.5em">
                <div class="space" style="height:2.5em;width:2.2em;display:inline"></div>
                <div class="3_t1" style="height:5em;width:2.4em;display:inline;background:#FFFFFF;margin-top:1em" >
                    <p style="text-align:center"><font size="8em" color="#000093">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline"></div>
                <div class="2_t1" style="height:5em;width:2.4em;display:inline;background:#FFFFFF;margin-top:1em" >
                    <p style="text-align:center"><font size="8em" color="#000093">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline"></div>
                <div class="1_t1" style="height:5em;width:2.4em;display:inline;background:#FFFFFF;margin-top:1em" >
                    <p style="text-align:center"><font size="8em" color="#000093">0</font></p>
                </div>
                <div class="devider" style="height:5em;width:3em;display:inline;margin-top:1em" >
                  <p style="text-align:right;margin-top:1em;margin-right:-1.1em"><font size="8em" color="#000093">:</font></p>
                </div>
              </div>
            </div>
          </div>

          <div class="Team2" style="width:50%;height:100%;margin-top:3%;margin-bottom:2%;margin-right:2%">
            <div class="vs" style="background:#E0E0E0;height:11em">

              <div style="height:4em;width:100%;display:inline-flex">
                
                <div class="TName2" style="height:4em;width:70%">
                    <p style="margin-top:1.2em;text-align:right"><font size="2.5em" color=" #000093">干</font></p>
                </div>
                <div style="height:4em;width:35%;">
                    <img src="abc.jpg" class="THead2 img-circle" width="75%" height="75%" style="text-align:right;margin-top:13%;margin-left:13%">
                </div>
              </div>

              <!--<div class="space" style="height:0.15em;background: #FFFFFF">&nbsp;</div>-->
              
              <div class="aga" style="display:inline-flex;height:2.5em">
                <div class="space" style="height:5em;width:3em;display:inline;margin-top: 1em;" >
                    <p style="text-align:left;margin-top:1em;margin-left:-0.5em;"><font size="8em" color="#000093">:</font></p>
                </div>
                <div class="3_t2" style="height:5em;width:2.4em;display:inline;background:#FFFFFF;margin-top: 1em;" >
                    <p style="text-align:center"><font size="8em" color="#000093">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline"></div>
                <div class="2_t2" style="height:5em;width:2.4em;display:inline;background:#FFFFFF;margin-top: 1em;" >
                    <p style="text-align:center"><font size="8em" color="#000093">0</font></p>
                </div>
                <div class="space" style="height:5em;width:0.2em;display:inline"></div>
                <div class="1_t2" style="height:5em;width:2.4em;display:inline;background:#FFFFFF;margin-top:1em" >
                    <p style="text-align:center"><font size="8em" color="#000093">0</font></p>
                </div>
              </div>
            </div>
          </div>
          </div>
      </div>
      <!--END FOR FINISHED LIST-->
      </div>
  </div> 
  </div>
</div>

</body>
</html>
